name: Build Android APK (Kivy) - 32+64

on:
  workflow_dispatch:

jobs:
  build:
    name: build (${{ matrix.arch }})
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        arch: [arm64-v8a, armeabi-v7a]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            zip unzip git curl \
            openjdk-17-jdk \
            build-essential \
            ccache \
            libffi-dev libssl-dev libz-dev \
            python3-dev pkg-config \
            autoconf automake libtool \
            zlib1g-dev

      - name: Install build tools (buildozer/p4a)
        run: |
          python -m pip install --upgrade pip
          pip install "buildozer==1.5.0" "cython==0.29.36"

      # 关键：准备 Android SDK + cmdline-tools，并做 tools/bin/sdkmanager 兼容链接（避免你之前反复出现的 sdkmanager 找不到、JDK版本不匹配）
      - name: Prepare Android SDK (cmdline-tools) + sdkmanager shim
        shell: bash
        run: |
          set -eux

          SDKROOT="$HOME/.buildozer/android/platform/android-sdk"
          mkdir -p "$SDKROOT"
          cd /tmp

          # 下载官方 cmdline-tools（稳定）
          curl -fsSL -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          rm -rf /tmp/cmdline-tools-tmp
          mkdir -p /tmp/cmdline-tools-tmp
          unzip -q cmdline-tools.zip -d /tmp/cmdline-tools-tmp
          rm -f cmdline-tools.zip

          rm -rf "$SDKROOT/cmdline-tools/latest"
          mkdir -p "$SDKROOT/cmdline-tools"
          mv /tmp/cmdline-tools-tmp/cmdline-tools "$SDKROOT/cmdline-tools/latest"
          rm -rf /tmp/cmdline-tools-tmp

          # buildozer/p4a 有时会去找 $SDKROOT/tools/bin/sdkmanager（老路径）
          # 我们创建一个兼容链接，指向新 cmdline-tools 的 sdkmanager
          mkdir -p "$SDKROOT/tools/bin"
          ln -sf "$SDKROOT/cmdline-tools/latest/bin/sdkmanager" "$SDKROOT/tools/bin/sdkmanager"

          # PATH
          echo "$SDKROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "$SDKROOT/tools/bin" >> "$GITHUB_PATH"

          # 输出确认
          which sdkmanager
          sdkmanager --version || true

      - name: Accept licenses + install Android packages
        shell: bash
        run: |
          set -eux

          SDKROOT="$HOME/.buildozer/android/platform/android-sdk"

          # 接受许可（防止你之前卡在 license）
          yes | sdkmanager --sdk_root="$SDKROOT" --licenses || true

          # 安装必需组件：
          # build-tools 36.1.0：解决你之前 aidl not found
          sdkmanager --sdk_root="$SDKROOT" \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;36.1.0" \
            "ndk;25.2.9519653"

          # 再接受一次许可，确保完整
          yes | sdkmanager --sdk_root="$SDKROOT" --licenses || true

      # 关键：自动下载中文字体并放进项目（让 APK 里中文不再“口口口/乱码方块”）
      - name: Download Chinese font (NotoSansSC)
        shell: bash
        run: |
          set -eux
          mkdir -p fonts
          # 从 Google Noto 仓库下载（稳定）
          curl -fsSL -o fonts/NotoSansSC-Regular.otf \
            https://raw.githubusercontent.com/googlefonts/noto-cjk/main/Sans/OTF/SimplifiedChinese/NotoSansSC-Regular.otf
          ls -lh fonts/NotoSansSC-Regular.otf

      # 关键：每个矩阵架构都要构建一次，因此我们自动改 buildozer.spec 里的 android.archs
      - name: Patch buildozer.spec for arch
        shell: bash
        run: |
          set -eux
          python - << 'PY'
          import re
          path = "buildozer.spec"
          txt = open(path, "r", encoding="utf-8").read()
          arch = "${{ matrix.arch }}"
          # 强制写入 android.archs
          if re.search(r"^\s*android\.archs\s*=", txt, flags=re.M):
            txt = re.sub(r"^\s*android\.archs\s*=.*$", f"android.archs = {arch}", txt, flags=re.M)
          else:
            txt += f"\nandroid.archs = {arch}\n"
          open(path, "w", encoding="utf-8").write(txt)
          print("Patched android.archs =", arch)
          PY
          grep -n "android.archs" buildozer.spec || true

      - name: Build APK
        shell: bash
        env:
          ANDROID_HOME: ${{ runner.temp }}/android-home-not-used
        run: |
          set -eux

          # 强制让 buildozer/p4a 使用我们准备的 SDK
          export ANDROIDSDK="$HOME/.buildozer/android/platform/android-sdk"
          export ANDROID_SDK_ROOT="$ANDROIDSDK"
          export ANDROID_HOME="$ANDROIDSDK"
          export ANDROID_NDK_HOME="$ANDROIDSDK/ndk/25.2.9519653"

          buildozer -v android debug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.arch }}
          path: bin/*.apk
